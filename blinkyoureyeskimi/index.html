<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœ¨çœ¼æé†’åŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
        }

        header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        header p {
            color: #888;
            font-size: 1.1rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #00d4ff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .video-container {
            position: relative;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 4/3;
        }

        #input_video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #output_canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }

        .camera-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }

        .camera-placeholder svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-size: 0.9rem;
            color: #aaa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-group label span {
            color: #00d4ff;
            font-weight: bold;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .toggle-switch input {
            display: none;
        }

        .toggle-slider {
            width: 50px;
            height: 26px;
            background: #444;
            border-radius: 13px;
            position: relative;
            transition: background 0.3s;
        }

        .toggle-slider::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: #00d4ff;
        }

        .toggle-switch input:checked + .toggle-slider::after {
            transform: translateX(24px);
        }

        .toggle-label {
            font-size: 0.95rem;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00d4ff;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00d4ff;
            cursor: pointer;
            border: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #c44569);
            color: #fff;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 71, 87, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: rgba(0, 212, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #00d4ff;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #888;
            margin-top: 5px;
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 15px;
        }

        .alert-box {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid rgba(255, 71, 87, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .alert-box.show {
            display: block;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .alert-box h3 {
            color: #ff4757;
            font-size: 1.1rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tips-container {
            margin-top: 15px;
        }

        .tip-card {
            background: rgba(123, 44, 191, 0.1);
            border: 1px solid rgba(123, 44, 191, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .tip-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .tip-content h4 {
            font-size: 0.95rem;
            color: #7b2cbf;
            margin-bottom: 4px;
        }

        .tip-content p {
            font-size: 0.85rem;
            color: #aaa;
            line-height: 1.4;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            background: rgba(68, 68, 68, 0.5);
        }

        .status-indicator.active {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .status-indicator.active .status-dot {
            background: #00d4ff;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .eye-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .eye-status.open {
            background: rgba(0, 212, 255, 0.3);
            color: #00d4ff;
        }

        .eye-status.closed {
            background: rgba(255, 71, 87, 0.3);
            color: #ff4757;
        }

        .user-match-section {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
            margin-top: 15px;
        }

        .user-id-display {
            background: rgba(0, 212, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.85rem;
            color: #00d4ff;
            word-break: break-all;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 212, 255, 0.3);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: #00d4ff;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <p class="loading-text">æ­£åœ¨åŠ è½½æ¨¡å‹...</p>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>ğŸ‘ï¸ çœ¨çœ¼æé†’åŠ©æ‰‹</h1>
            <p>ä¿æŠ¤çœ¼ç›ï¼Œä»è§„å¾‹çœ¨çœ¼å¼€å§‹</p>
        </header>

        <div class="main-grid">
            <div class="left-column">
                <div class="panel">
                    <h2 class="panel-title">
                        <span>ğŸ“¹</span>
                        æ‘„åƒå¤´é¢„è§ˆ
                        <span class="status-indicator" id="statusIndicator">
                            <span class="status-dot"></span>
                            <span id="statusText">æœªå¯åŠ¨</span>
                        </span>
                    </h2>
                    <div class="video-container">
                        <video id="input_video" autoplay playsinline></video>
                        <canvas id="output_canvas"></canvas>
                        <div class="camera-placeholder" id="cameraPlaceholder">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.5.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.63c-.04.34-.07.67-.07 1 0 .33.03.66.07.97l-2.11 1.63c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.63Z"/>
                            </svg>
                            <p>ç‚¹å‡»"å¯åŠ¨æ£€æµ‹"å¼€å§‹ä½¿ç”¨</p>
                        </div>
                        <div class="eye-status" id="eyeStatus" style="display: none;">çœ¼ç›: æ£€æµ‹ä¸­</div>
                    </div>
                </div>

                <div class="panel" style="margin-top: 20px;">
                    <h2 class="panel-title">
                        <span>ğŸ“Š</span>
                        çœ¨çœ¼ç»Ÿè®¡
                    </h2>
                    <div class="chart-container">
                        <canvas id="blinkChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="panel">
                    <h2 class="panel-title">
                        <span>âš™ï¸</span>
                        æ§åˆ¶é¢æ¿
                    </h2>

                    <div class="controls">
                        <button class="btn btn-primary" id="startBtn">
                            <span>â–¶ï¸</span> å¯åŠ¨æ£€æµ‹
                        </button>
                        <button class="btn btn-danger" id="stopBtn" disabled>
                            <span>â¹ï¸</span> åœæ­¢è¯†åˆ«
                        </button>

                        <div class="control-group">
                            <label>çœ¨çœ¼æ£€æµ‹é˜ˆå€¼: <span id="thresholdValue">0.25</span></label>
                            <input type="range" id="thresholdSlider" min="0.1" max="0.5" step="0.01" value="0.25">
                            <small style="color: #666; font-size: 0.8rem;">
                                æ•°å€¼è¶Šå°è¶Šå®¹æ˜“æ£€æµ‹åˆ°çœ¨çœ¼ï¼Œå»ºè®®æ ¹æ®ç¯å¢ƒå…‰è°ƒæ•´
                            </small>
                        </div>

                        <div class="control-group">
                            <label class="toggle-switch">
                                <input type="checkbox" id="userMatchToggle">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">å¯ç”¨ç”¨æˆ·è¯†åˆ« (æ¶ˆè€—æ›´å¤šç®—åŠ›)</span>
                            </label>
                        </div>

                        <div class="control-group">
                            <label class="toggle-switch">
                                <input type="checkbox" id="soundToggle" checked>
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">å¯ç”¨æé†’éŸ³æ•ˆ</span>
                            </label>
                        </div>

                        <div class="user-match-section" id="userMatchSection" style="display: none;">
                            <label style="font-size: 0.9rem; color: #aaa; margin-bottom: 8px; display: block;">
                                å½“å‰ç”¨æˆ·ID
                            </label>
                            <div class="user-id-display" id="userIdDisplay">æœªè¯†åˆ«</div>
                        </div>
                    </div>
                </div>

                <div class="panel" style="margin-top: 20px;">
                    <h2 class="panel-title">
                        <span>ğŸ“ˆ</span>
                        å®æ—¶æ•°æ®
                    </h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalBlinks">0</div>
                            <div class="stat-label">æ€»çœ¨çœ¼æ¬¡æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="blinkRate">0</div>
                            <div class="stat-label">æ¯åˆ†é’Ÿçœ¨çœ¼</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="lastBlinkTime">--</div>
                            <div class="stat-label">ä¸Šæ¬¡çœ¨çœ¼(ç§’)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgBlinkRate">0</div>
                            <div class="stat-label">å¹³å‡é¢‘ç‡</div>
                        </div>
                    </div>
                </div>

                <div class="alert-box" id="alertBox">
                    <h3>âš ï¸ çœ¨çœ¼æé†’</h3>
                    <p id="alertText">æ‚¨å·²ç»å¾ˆä¹…æ²¡æœ‰çœ¨çœ¼äº†ï¼Œè¯·çœ¨çœ¨çœ¼ä¿æŠ¤çœ¼ç›ï¼</p>
                </div>

                <div class="panel" style="margin-top: 20px;">
                    <h2 class="panel-title">
                        <span>ğŸ’¡</span>
                        æŠ¤çœ¼å°è´´å£«
                    </h2>
                    <div class="tips-container" id="tipsContainer">
                        <!-- Tips will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== é…ç½®å’ŒçŠ¶æ€ ====================
        const CONFIG = {
            EAR_THRESHOLD: 0.25,        // çœ¼ç›çºµæ¨ªæ¯”é˜ˆå€¼
            BLINK_MIN_FRAMES: 2,        // æœ€å°çœ¨çœ¼å¸§æ•°
            BLINK_MAX_FRAMES: 10,       // æœ€å¤§çœ¨çœ¼å¸§æ•°
            ALERT_INTERVAL: 8000,       // æé†’é—´éš”(8ç§’ä¸çœ¨çœ¼æé†’)
            CHART_INTERVAL: 30000,      // å›¾è¡¨æ›´æ–°é—´éš”(30ç§’)
            HISTORY_SIZE: 20            // å›¾è¡¨å†å²æ•°æ®ç‚¹æ•°é‡
        };

        const STATE = {
            isRunning: false,
            isUserMatchEnabled: false,
            isSoundEnabled: true,
            blinkCount: 0,
            blinkHistory: [],           // æ¯ä¸ªæ—¶é—´æ®µçš„çœ¨çœ¼æ¬¡æ•°
            lastBlinkTime: Date.now(),
            lastChartUpdate: Date.now(),
            blinkTimestamps: [],        // è®°å½•æ‰€æœ‰çœ¨çœ¼æ—¶é—´æˆ³
            eyeClosedFrames: 0,
            isEyeClosed: false,
            currentUserId: null,
            frameCount: 0
        };

        // ==================== MediaPipe åˆå§‹åŒ– ====================
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');

        let faceMesh = null;
        let camera = null;

        // çœ¼ç›å…³é”®ç‚¹ç´¢å¼• (MediaPipe Face Mesh)
        const LEFT_EYE_INDICES = [362, 385, 387, 263, 373, 380];
        const RIGHT_EYE_INDICES = [33, 160, 158, 133, 153, 144];

        // ==================== å¥åº·æç¤º ====================
        const HEALTH_TIPS = [
            { icon: 'ğŸ’§', title: '20-20-20 æ³•åˆ™', text: 'æ¯20åˆ†é’Ÿï¼Œçœ‹20è‹±å°º(6ç±³)å¤–çš„ç‰©ä½“20ç§’' },
            { icon: 'ğŸ˜‰', title: 'å®Œå…¨çœ¨çœ¼', text: 'ç¼“æ…¢å®Œå…¨åœ°çœ¨çœ¼ï¼Œè®©æ³ªæ¶²å‡åŒ€åˆ†å¸ƒåœ¨çœ¼çƒè¡¨é¢' },
            { icon: 'ğŸ’§', title: 'ä¿æŒæ¹¿æ¶¦', text: 'é•¿æ—¶é—´ç”¨çœ¼ä¼šå¯¼è‡´çœ¼ç›å¹²æ¶©ï¼Œè®°å¾—å¤šå–æ°´' },
            { icon: 'ğŸ“', title: 'ä¿æŒè·ç¦»', text: 'çœ¼ç›ä¸å±å¹•ä¿æŒ50-70å˜ç±³çš„è·ç¦»' },
            { icon: 'ğŸ’¡', title: 'ç¯å¢ƒå…‰çº¿', text: 'é¿å…å±å¹•åå…‰ï¼Œä¿æŒé€‚å½“çš„ç¯å¢ƒå…‰çº¿' },
            { icon: 'ğŸ˜´', title: 'é€‚å½“ä¼‘æ¯', text: 'æ¯2å°æ—¶é—­çœ¼ä¼‘æ¯5-10åˆ†é’Ÿ' }
        ];

        // ==================== åˆå§‹åŒ– ====================
        function init() {
            renderTips();
            initChart();
            bindEvents();
        }

        function renderTips() {
            const container = document.getElementById('tipsContainer');
            container.innerHTML = HEALTH_TIPS.map(tip => `
                <div class="tip-card">
                    <span class="tip-icon">${tip.icon}</span>
                    <div class="tip-content">
                        <h4>${tip.title}</h4>
                        <p>${tip.text}</p>
                    </div>
                </div>
            `).join('');
        }

        // ==================== å›¾è¡¨ ====================
        let blinkChart = null;

        function initChart() {
            const ctx = document.getElementById('blinkChart').getContext('2d');
            blinkChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'çœ¨çœ¼æ¬¡æ•°',
                        data: [],
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'çœ¨çœ¼é¢‘ç‡(æ¬¡/åˆ†)',
                        data: [],
                        borderColor: '#7b2cbf',
                        backgroundColor: 'rgba(123, 44, 191, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#aaa' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        y: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            beginAtZero: true
                        },
                        y1: {
                            ticks: { color: '#888' },
                            grid: { display: false },
                            beginAtZero: true,
                            position: 'right'
                        }
                    }
                }
            });
        }

        function updateChart() {
            const now = Date.now();
            if (now - STATE.lastChartUpdate >= CONFIG.CHART_INTERVAL) {
                const timeLabel = new Date().toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                // è®¡ç®—è¿™30ç§’å†…çš„çœ¨çœ¼æ¬¡æ•°
                const periodBlinks = STATE.blinkTimestamps.filter(
                    t => t >= STATE.lastChartUpdate && t <= now
                ).length;

                // è®¡ç®—çœ¨çœ¼é¢‘ç‡(æ¬¡/åˆ†)
                const blinkRate = Math.round(periodBlinks * 2); // 30ç§’ * 2 = æ¯åˆ†é’Ÿ

                STATE.blinkHistory.push({ time: timeLabel, count: periodBlinks, rate: blinkRate });

                // ä¿æŒå†å²æ•°æ®åœ¨é™åˆ¶èŒƒå›´å†…
                if (STATE.blinkHistory.length > CONFIG.HISTORY_SIZE) {
                    STATE.blinkHistory.shift();
                }

                // æ›´æ–°å›¾è¡¨
                blinkChart.data.labels = STATE.blinkHistory.map(h => h.time);
                blinkChart.data.datasets[0].data = STATE.blinkHistory.map(h => h.count);
                blinkChart.data.datasets[1].data = STATE.blinkHistory.map(h => h.rate);
                blinkChart.update();

                STATE.lastChartUpdate = now;

                // æ¸…ç†æ—§çš„æ—¶é—´æˆ³
                STATE.blinkTimestamps = STATE.blinkTimestamps.filter(
                    t => t > now - CONFIG.CHART_INTERVAL * CONFIG.HISTORY_SIZE
                );
            }
        }

        // ==================== äººè„¸/çœ¼ç›æ£€æµ‹ ====================
        async function initFaceMesh() {
            faceMesh = new FaceMesh({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                }
            });

            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            faceMesh.onResults(onResults);
        }

        function onResults(results) {
            STATE.frameCount++;

            // æ¸…ç©ºç”»å¸ƒ
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];

                // ç»˜åˆ¶äººè„¸ç½‘æ ¼
                drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION,
                    { color: 'rgba(0, 212, 255, 0.3)', lineWidth: 1 });

                // ç»˜åˆ¶çœ¼ç›è½®å»“
                drawConnectors(canvasCtx, landmarks, FACEMESH_LEFT_EYE,
                    { color: '#00d4ff', lineWidth: 2 });
                drawConnectors(canvasCtx, landmarks, FACEMESH_RIGHT_EYE,
                    { color: '#00d4ff', lineWidth: 2 });

                // æ£€æµ‹çœ¨çœ¼
                detectBlink(landmarks);

                // ç”¨æˆ·è¯†åˆ«
                if (STATE.isUserMatchEnabled) {
                    updateUserIdentification(landmarks);
                }
            } else {
                document.getElementById('eyeStatus').style.display = 'none';
            }

            canvasCtx.restore();

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateStats();
            updateChart();
            checkAlert();
        }

        function detectBlink(landmarks) {
            // è®¡ç®—å·¦çœ¼çºµæ¨ªæ¯” (Eye Aspect Ratio)
            const leftEAR = calculateEAR(landmarks, LEFT_EYE_INDICES);
            const rightEAR = calculateEAR(landmarks, RIGHT_EYE_INDICES);
            const avgEAR = (leftEAR + rightEAR) / 2;

            // è·å–é˜ˆå€¼
            const threshold = parseFloat(document.getElementById('thresholdSlider').value);

            // æ›´æ–°çœ¼ç›çŠ¶æ€æ˜¾ç¤º
            const eyeStatusEl = document.getElementById('eyeStatus');
            eyeStatusEl.style.display = 'block';

            if (avgEAR < threshold) {
                // çœ¼ç›é—­åˆ
                STATE.eyeClosedFrames++;
                STATE.isEyeClosed = true;
                eyeStatusEl.textContent = 'çœ¼ç›: é—­åˆ';
                eyeStatusEl.className = 'eye-status closed';
            } else {
                // çœ¼ç›çå¼€
                if (STATE.isEyeClosed && STATE.eyeClosedFrames >= CONFIG.BLINK_MIN_FRAMES
                    && STATE.eyeClosedFrames <= CONFIG.BLINK_MAX_FRAMES) {
                    // æœ‰æ•ˆçš„çœ¨çœ¼
                    onBlinkDetected();
                }
                STATE.eyeClosedFrames = 0;
                STATE.isEyeClosed = false;
                eyeStatusEl.textContent = 'çœ¼ç›: çå¼€';
                eyeStatusEl.className = 'eye-status open';
            }
        }

        function calculateEAR(landmarks, indices) {
            // çœ¼ç›çºµæ¨ªæ¯” = (å‚ç›´è·ç¦»1 + å‚ç›´è·ç¦»2) / (2 * æ°´å¹³è·ç¦»)
            const p1 = landmarks[indices[0]];
            const p2 = landmarks[indices[1]];
            const p3 = landmarks[indices[2]];
            const p4 = landmarks[indices[3]];
            const p5 = landmarks[indices[4]];
            const p6 = landmarks[indices[5]];

            const vertical1 = distance(p2, p6);
            const vertical2 = distance(p3, p5);
            const horizontal = distance(p1, p4);

            return (vertical1 + vertical2) / (2 * horizontal);
        }

        function distance(p1, p2) {
            return Math.sqrt(
                Math.pow(p1.x - p2.x, 2) +
                Math.pow(p1.y - p2.y, 2) +
                Math.pow(p1.z - p2.z, 2)
            );
        }

        function onBlinkDetected() {
            STATE.blinkCount++;
            STATE.blinkTimestamps.push(Date.now());
            STATE.lastBlinkTime = Date.now();

            // æ’­æ”¾éŸ³æ•ˆ
            if (STATE.isSoundEnabled) {
                playBeep(800, 50);
            }

            // éšè—æé†’
            document.getElementById('alertBox').classList.remove('show');
        }

        function updateUserIdentification(landmarks) {
            // ç”Ÿæˆç®€åŒ–çš„é¢éƒ¨ç‰¹å¾æŒ‡çº¹
            // ä½¿ç”¨é¢éƒ¨å…³é”®ç‚¹ä¹‹é—´çš„è·ç¦»æ¯”ä¾‹æ¥åˆ›å»ºå”¯ä¸€æ ‡è¯†
            const keyPoints = [33, 133, 362, 263, 1, 152, 61, 291]; // çœ¼è§’ã€é¼»å°–ç­‰å…³é”®ç‚¹
            let fingerprint = '';

            for (let i = 0; i < keyPoints.length; i++) {
                for (let j = i + 1; j < keyPoints.length; j++) {
                    const d = distance(landmarks[keyPoints[i]], landmarks[keyPoints[j]]);
                    fingerprint += Math.round(d * 1000).toString(36);
                }
            }

            // å“ˆå¸Œå¤„ç†
            const userId = hashString(fingerprint).substring(0, 16);
            STATE.currentUserId = userId;
            document.getElementById('userIdDisplay').textContent = userId;
        }

        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        function updateStats() {
            document.getElementById('totalBlinks').textContent = STATE.blinkCount;

            // è®¡ç®—æ¯åˆ†é’Ÿçœ¨çœ¼ç‡
            const now = Date.now();
            const oneMinuteAgo = now - 60000;
            const recentBlinks = STATE.blinkTimestamps.filter(t => t > oneMinuteAgo).length;
            document.getElementById('blinkRate').textContent = recentBlinks;

            // ä¸Šæ¬¡çœ¨çœ¼æ—¶é—´
            const timeSinceLastBlink = Math.floor((now - STATE.lastBlinkTime) / 1000);
            document.getElementById('lastBlinkTime').textContent = timeSinceLastBlink;

            // å¹³å‡çœ¨çœ¼ç‡
            if (STATE.blinkHistory.length > 0) {
                const avgRate = STATE.blinkHistory.reduce((sum, h) => sum + h.rate, 0) / STATE.blinkHistory.length;
                document.getElementById('avgBlinkRate').textContent = Math.round(avgRate);
            }
        }

        function checkAlert() {
            const timeSinceLastBlink = Date.now() - STATE.lastBlinkTime;
            const alertBox = document.getElementById('alertBox');

            if (timeSinceLastBlink > CONFIG.ALERT_INTERVAL) {
                alertBox.classList.add('show');

                if (STATE.isSoundEnabled && timeSinceLastBlink % 2000 < 100) {
                    playBeep(400, 100);
                }

                // æ›´æ–°æç¤ºæ–‡æœ¬
                const seconds = Math.floor(timeSinceLastBlink / 1000);
                document.getElementById('alertText').textContent =
                    `æ‚¨å·²ç» ${seconds} ç§’æ²¡æœ‰çœ¨çœ¼äº†ï¼Œè¯·çœ¨çœ¨çœ¼ä¿æŠ¤çœ¼ç›ï¼`;
            } else {
                alertBox.classList.remove('show');
            }
        }

        function playBeep(frequency, duration) {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration / 1000);

                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + duration / 1000);
            } catch (e) {
                console.log('Audio play failed:', e);
            }
        }

        // ==================== äº‹ä»¶ç»‘å®š ====================
        function bindEvents() {
            // å¯åŠ¨æŒ‰é’®
            document.getElementById('startBtn').addEventListener('click', async () => {
                await startDetection();
            });

            // åœæ­¢æŒ‰é’®
            document.getElementById('stopBtn').addEventListener('click', () => {
                stopDetection();
            });

            // é˜ˆå€¼æ»‘å—
            document.getElementById('thresholdSlider').addEventListener('input', (e) => {
                document.getElementById('thresholdValue').textContent = e.target.value;
            });

            // ç”¨æˆ·åŒ¹é…å¼€å…³
            document.getElementById('userMatchToggle').addEventListener('change', (e) => {
                STATE.isUserMatchEnabled = e.target.checked;
                document.getElementById('userMatchSection').style.display =
                    e.target.checked ? 'block' : 'none';
            });

            // éŸ³æ•ˆå¼€å…³
            document.getElementById('soundToggle').addEventListener('change', (e) => {
                STATE.isSoundEnabled = e.target.checked;
            });
        }

        async function startDetection() {
            if (STATE.isRunning) return;

            document.getElementById('loadingOverlay').classList.add('show');

            try {
                // è®¾ç½®ç”»å¸ƒå°ºå¯¸
                canvasElement.width = 640;
                canvasElement.height = 480;

                // åˆå§‹åŒ– Face Mesh
                await initFaceMesh();

                // åˆå§‹åŒ–æ‘„åƒå¤´
                camera = new Camera(videoElement, {
                    onFrame: async () => {
                        await faceMesh.send({ image: videoElement });
                    },
                    width: 640,
                    height: 480
                });

                await camera.start();

                STATE.isRunning = true;
                STATE.lastBlinkTime = Date.now();
                STATE.lastChartUpdate = Date.now();

                // æ›´æ–°UI
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('cameraPlaceholder').style.display = 'none';
                document.getElementById('statusIndicator').classList.add('active');
                document.getElementById('statusText').textContent = 'æ£€æµ‹ä¸­';

            } catch (error) {
                console.error('å¯åŠ¨å¤±è´¥:', error);
                alert('å¯åŠ¨å¤±è´¥ï¼Œè¯·ç¡®ä¿å…è®¸æ‘„åƒå¤´è®¿é—®æƒé™');
            } finally {
                document.getElementById('loadingOverlay').classList.remove('show');
            }
        }

        function stopDetection() {
            if (!STATE.isRunning) return;

            // åœæ­¢æ‘„åƒå¤´
            if (camera) {
                try {
                    const stream = videoElement.srcObject;
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                } catch (e) {
                    console.error('åœæ­¢æ‘„åƒå¤´å¤±è´¥:', e);
                }
            }

            STATE.isRunning = false;

            // æ›´æ–°UI
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('cameraPlaceholder').style.display = 'block';
            document.getElementById('statusIndicator').classList.remove('active');
            document.getElementById('statusText').textContent = 'å·²åœæ­¢';
            document.getElementById('eyeStatus').style.display = 'none';

            // æ¸…ç©ºç”»å¸ƒ
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        }

        // ==================== å¯åŠ¨åº”ç”¨ ====================
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
