"use strict";(globalThis.webpackChunkvideoencdec=globalThis.webpackChunkvideoencdec||[]).push([[792],{465:(e,t,i)=>{const s={level:2,enablePerformanceLogging:!0,enableConsoleOutput:!0,enableFileOutput:!1,maxLogEntries:1e3},r=new class{constructor(){this.logEntries=[],this.performanceMetrics=new Map}log(e,t,i,r=null){if(e>s.level)return;const a={timestamp:(new Date).toISOString(),level:this.getLevelName(e),context:t,message:i,data:r,performance:performance.now()};this.logEntries.push(a),this.logEntries.length>s.maxLogEntries&&this.logEntries.shift(),s.enableConsoleOutput&&this.outputToConsole(a),s.enableFileOutput&&this.outputToFile(a)}getLevelName(e){return["ERROR","WARN","INFO","DEBUG","VERBOSE"][e]||"UNKNOWN"}outputToConsole(e){const{level:t,context:i,message:s,data:r}=e,a=`[${t}] [${i}]`;switch(t){case"ERROR":console.error(a,s,r||"");break;case"WARN":console.warn(a,s,r||"");break;case"INFO":console.info(a,s,r||"");break;case"DEBUG":case"VERBOSE":console.log(a,s,r||"")}}outputToFile(e){}recordPerformance(e,t,i="ms"){if(!s.enablePerformanceLogging)return;this.performanceMetrics.has(e)||this.performanceMetrics.set(e,[]),this.performanceMetrics.get(e).push({value:t,unit:i,timestamp:Date.now()});const r=this.performanceMetrics.get(e);r.length>100&&r.shift()}getPerformanceStats(e){const t=this.performanceMetrics.get(e);if(!t||0===t.length)return null;const i=t.map(e=>e.value),s=i.reduce((e,t)=>e+t,0),r=s/i.length,a=Math.min(...i),n=Math.max(...i);return{name:e,count:i.length,average:r,min:a,max:n,total:s}}getLogEntries(){return[...this.logEntries]}clearLogs(){this.logEntries=[]}exportLogs(){return JSON.stringify({logs:this.logEntries,performance:Object.fromEntries(this.performanceMetrics),config:s},null,2)}};function a(e,t,i=null){r.log(0,e,t,i)}function n(e,t,i=null){r.log(2,e,t,i)}function o(e,t,i=null){r.log(3,e,t,i)}function h(e,t,i=null){r.log(4,e,t,i)}class l{static sampleTimeMs(e){return 1e3*e.cts/e.timescale}static encodedVideoChunkFromSample(e){return new EncodedVideoChunk({type:e.is_sync?"key":"delta",timestamp:1e6*e.cts/e.timescale,duration:1e6*e.duration/e.timescale,data:e.data})}constructor(){this.samples=[],this.originalSamples=null,this.currentIndex=0,this.finalized=!1,this.state="receiving",this.readyPromise=new Promise(e=>{this.resolveReadyPromise=e})}sampleCount(){return this.samples.length}addSamples(e){if(this.finalized)throw new Error("Cannot add samples to finalized SampleManager");this.samples.push(...e)}async waitForReady(){"finalized"!==this.state&&await this.readyPromise}finalize(){this.originalSamples=this.samples,this.resolveReadyPromise(),this.resolveReadyPromise=null,this.state="finalized"}finalizeTimeRange(e,t){this.samples=this.originalSamples;let i=0,s=this.samples.length,r=0,a=this.samples.length-1;if(void 0!==e)for(i=this.lowerBound(e),r=i;i>0&&!this.samples[i].is_sync;)i--;if(void 0!==t){for(s=this.upperBound(t),a=s;s<this.samples.length-1&&!this.samples[s+1].is_sync;)s++;s++}if(a>=this.samples.length&&(a=this.samples.length-1),r>=this.samples.length)throw new Error("Invalid sample range");const n=l.sampleTimeMs(this.samples[r]),o=l.sampleTimeMs(this.samples[a]);return this.samples=this.samples.slice(i,s),this.currentIndex=0,this.finalized=!0,[this.samples.length,n,o]}finalizeSampleInIndex(e,t){this.samples=this.originalSamples;let i=e;for(;e>0&&!this.samples[e].is_sync;)e--;for(t>=this.samples.length&&(t=this.samples.length-1);t>0&&!this.samples[t].cts;)t--;if(e>=t)throw new Error("Invalid sample range");const s=l.sampleTimeMs(this.samples[i]),r=l.sampleTimeMs(this.samples[t]);return this.samples=this.samples.slice(e,t+1),this.currentIndex=0,this.finalized=!0,[this.samples.length,s,r]}lowerBound(e){let t=0,i=this.samples.length-1;for(;t<=i;){const s=Math.floor((t+i)/2);l.sampleTimeMs(this.samples[s])<e?t=s+1:i=s-1}return t}upperBound(e){let t=0,i=this.samples.length-1;for(;t<=i;){const s=Math.floor((t+i)/2);l.sampleTimeMs(this.samples[s])<=e?t=s+1:i=s-1}return i}requestChunks(e,t,i){let s=0;for(;s<e&&this.currentIndex<this.samples.length;){const e=this.samples[this.currentIndex];t(l.encodedVideoChunkFromSample(e)),this.currentIndex++,s++}return this.currentIndex>=this.samples.length&&i(),s}findSamplesAtPercentage(e){if(this.finalized)throw new Error("Cannot find sample in finalized SampleManager");const t=Math.floor(e/100*(this.samples.length-1));let i=t;for(;i>0&&!this.samples[i].is_sync;)i--;return this.samples.slice(i,t+1)}reset(){this.currentIndex=0,this.samples=[],this.originalSamples=null,this.currentIndex=0,this.finalized=!1}resetForReprocessing(){this.currentIndex=0,this.finalized=!1,this.samples=this.originalSamples}}var c=i(905);class d{constructor({onFrame:e,onDequeue:t,onError:i,isChromeBased:s}){this.decoder=null,this.onFrame=e,this.onDequeue=t,this.onError=i,this.isChromeBased=s}async setup(e){this.decoder=new window.VideoDecoder({output:e=>this.onFrame(e),error:e=>this.onError(e)}),this.isChromeBased&&(this.decoder.ondequeue=()=>{const e=23-this.decoder.decodeQueueSize;e>0&&this.onDequeue&&this.onDequeue(e)}),await this.decoder.configure(e)}startTimerDispatch(e){setTimeout(()=>{const t=23-this.decodeQueueSize;e(t)},1e3)}get decodeQueueSize(){return this.decoder?.decodeQueueSize||0}setState(e){this.state=e}decode(e){this.decoder?.decode(e)}async flush(){await(this.decoder?.flush())}}class m{constructor(e,{onConfig:t,setStatus:i,sampleManager:s}){this.onConfig=t,this.setStatus=i,this.file=(0,c.x3)(),this.file.onError=e=>i("demux",e),this.file.onReady=this.onReady.bind(this),this.file.onSamples=this.onSamples.bind(this),this.nb_samples=0,this.passed_samples=0,this.stopProcessingSamples=!1,this.sampleManager=s,this.setupFile(e)}async setupFile(e){const t=new u(this.file,this.setStatus),i=await fetch(e);await i.body.pipeTo(new WritableStream(t,{highWaterMark:2}))}getDescription(e){const t=this.file.getTrackById(e.id);for(const e of t.mdia.minf.stbl.stsd.entries){const t=e.avcC||e.hvcC||e.vpcC||e.av1C;if(t){const e=new c.dc(void 0,0,c.dc.BIG_ENDIAN);return t.write(e),new Uint8Array(e.buffer,8)}}throw new Error("avcC, hvcC, vpcC, or av1C box not found")}calculateFPS(e){const t=e.duration/e.timescale,i=e.nb_samples/t;return Math.round(100*i)/100}onReady(e){this.setStatus("demux","Ready");const t=e.videoTracks[0],i=1e3*t.duration/t.timescale,s=t.created?new Date(t.created.getTime()-i):new Date;this.onConfig({codec:t.codec,codedHeight:t.video.height,codedWidth:t.video.width,description:this.getDescription(t),nb_samples:t.nb_samples,matrix:t.matrix,startTime:s,fps:this.calculateFPS(t)}),this.nb_samples=t.nb_samples,this.file.setExtractionOptions(t.id),this.file.start()}onSamples(e,t,i){this.stopProcessingSamples||(this.passed_samples+=i.length,this.sampleManager.addSamples(i),this.passed_samples>=this.nb_samples&&(this.stopProcessingSamples=!0,this.sampleManager.finalize()))}}class u{constructor(e,t){this.file=e,this.setStatus=t,this.offset=0}write(e){const t=new ArrayBuffer(e.byteLength);new Uint8Array(t).set(e),t.fileStart=this.offset,this.offset+=t.byteLength,this.setStatus("fetch",`${(this.offset/1024/1024).toFixed(1)} MB`),this.file.appendBuffer(t)}close(){this.setStatus("fetch","Complete"),this.file.flush()}}class p{constructor(e,t){this.decoder=e,this.sampleManager=t,this.previewFrameTimeStamp=0}preparePreview(e){const t=this.sampleManager.findSamplesAtPercentage(e),i=l.sampleTimeMs(t[t.length-1]);return this.samples=t,this.previewFrameTimeStamp=i,i}executePreview(e){if(e!==this.previewFrameTimeStamp)return null;for(const e of this.samples){const t=l.encodedVideoChunkFromSample(e);this.decoder.decode(t)}return this.decoder.flush()}drawPreview(e,t){Math.floor(this.previewFrameTimeStamp)===Math.floor(e.timestamp/1e3)&&(t(e),this.previewFrameTimeStamp=0)}}class g{constructor(e){this.ctx=e,this.matrix=null,this.width=0,this.height=0,this.zoom=1,this.rotation=0}setup(e,t,i,s=1){this.width=e,this.height=t,this.matrix=i,this.zoom=s}updateRotation(e){this.rotation=e}drawFrame(e){this.ctx.save();const t=this.ctx.canvas.width,i=this.ctx.canvas.height;this.ctx.translate(t/2,i/2),this.ctx.rotate(this.rotation*Math.PI/180);const s=this.width*this.zoom,r=this.height*this.zoom,a=(this.width-s)/2,n=(this.height-r)/2;this.ctx.drawImage(e,a,n,s,r,-s/2,-r/2,s,r),this.ctx.restore()}}class f{constructor(e){this.startTime=e,this.extraTimeOffsetMS=0}draw(e,t){const i=new Date(this.startTime.getTime()+this.extraTimeOffsetMS+t).toLocaleString("sv",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replace(" "," "),s=.03*Math.min(e.canvas.width,e.canvas.height);e.fillStyle="white",e.font=`${s}px Arial`,e.textAlign="right",e.fillText(i,e.canvas.width-10,e.canvas.height-10)}updateExtraTimeOffsetMS(e){this.extraTimeOffsetMS=e}}class v{constructor({canvas:e,statusElement:t,frameCountDisplay:i,timestampProvider:s}){this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.statusElement=t,this.frameCountDisplay=i,this.timestampProvider=s,this.frameRenderer=new g(this.ctx),this.timestampRenderer=null,this.videoWidth=0,this.videoHeight=0,this.zoom=1,this.rotation=0,this.matrix=null}setStatus(e,t){this.statusElement.textContent=`${e}: ${t}`}updateFrameCount(e,t){this.frameCountDisplay.textContent=`Processed frames: ${e} / ${t}`}setup(e,t,i,s,r){this.videoWidth=e,this.videoHeight=t,this.zoom=s,this.rotation=r,this.matrix=i,this.frameRenderer.setup(e,t,i,s),this.updateRotation(r)}updateRotation(e){this.rotation=e,this.frameRenderer.updateRotation(this.rotation);const{width:t,height:i}=this.getCanvasDimensions();this.setupCanvas(t,i)}updateZoom(e){this.zoom=e,this.frameRenderer.setup(this.videoWidth,this.videoHeight,this.matrix,e);const{width:t,height:i}=this.getCanvasDimensions();this.setupCanvas(t,i)}setupCanvas(e,t){this.canvas.width=e,this.canvas.height=t}getCanvasDimensions(){const e=this.rotation%180!=0;return{width:e?this.videoHeight*this.zoom:this.videoWidth*this.zoom,height:e?this.videoWidth*this.zoom:this.videoHeight*this.zoom}}drawFrame(e){this.frameRenderer.drawFrame(e)}drawTimestamp(e){this.timestampRenderer&&this.timestampRenderer.draw(this.ctx,e)}createTimestampRenderer(e,t,i){if(!this.timestampProvider.isEnabled())return void(this.timestampRenderer=null);let s=e||t||new Date;this.timestampRenderer=new f(s),e&&this.timestampRenderer.updateExtraTimeOffsetMS(-i)}}var w=i(46);class P{constructor(){this.encoder=null,this.blockingPromise=null,this.blockingPromiseResolve=null,this.muxer=null,this.chunks=[],this.fileHandle=null,this.fileStream=null,this.root=null,this.tempFileName="temp-manji.mp4",this.frameCount=0,this.fps=30}async init(e,t,i,s,r=!1){h("Initializing encoder with dimensions:",{width:e,height:t,fps:i}),this.fps=i,this.frameCount=0;let a=e,n=t;const o=a*n,l=Math.min(Math.floor(.2*o*30),3e7);r?(this.fileWorker=new Worker("fileWorker.js"),this.fileWorker.postMessage({type:"init",data:{fileName:this.tempFileName}}),this.muxer=new w._j({target:new w.Kw({chunked:!0,onData:(e,t)=>{this.fileWorker.postMessage({type:"write",data:{chunk:new Uint8Array(e),position:t}})}}),fastStart:!1,video:{codec:"avc",width:a,height:n},firstTimestampBehavior:"offset"})):this.muxer=new w._j({target:new w.Kw({chunked:!0,onData:(e,t)=>{this.chunks.push({data:new Uint8Array(e),position:t})}}),fastStart:"in-memory",video:{codec:"avc",width:a,height:n},firstTimestampBehavior:"offset"}),this.encoder=new window.VideoEncoder({output:(e,t)=>this.muxer.addVideoChunk(e,t),error:e=>console.error("Encoding error:",e)}),this.encoder.ondequeue=()=>{this.blockingPromise&&this.encoder.encodeQueueSize<23&&(this.blockingPromiseResolve(),this.blockingPromise=null,this.blockingPromiseResolve=null),0===this.encoder.encodeQueueSize&&this.onQueueEmpty&&this.onQueueEmpty()};const c={codec:"avc1.640033",width:a,height:n,framerate:i};s&&(c.bitrate=l),await this.encoder.configure(c)}setQueueEmptyCallback(e){this.onQueueEmpty=e}get encodeQueueSize(){return this.encoder?this.encoder.encodeQueueSize:0}async encode(e){for(;this.encoder.encodeQueueSize>23;)this.blockingPromise||(this.blockingPromise=new Promise(e=>{this.blockingPromiseResolve=e})),await this.blockingPromise;this.frameCount++;const t=Math.round(this.fps);(this.frameCount-1)%t==0?(h(`Forcing keyframe at frame ${this.frameCount} (fps: ${this.fps}, interval: ${t})`),this.encoder.encode(e,{keyFrame:!0})):this.encoder.encode(e),e.close()}async finalize(){if(await this.encoder.flush(),this.encoder.close(),this.muxer.finalize(),this.fileWorker){this.fileWorker.postMessage({type:"close"}),await new Promise((e,t)=>{const i=setTimeout(()=>{console.warn("[VideoEncoder] File worker timeout, continuing anyway"),this.fileWorker.terminate(),e()},5e3);this.fileWorker.onmessage=t=>{"closed"===t.data.type&&(clearTimeout(i),this.fileWorker.terminate(),e())},this.fileWorker.onerror=e=>{clearTimeout(i),console.error("[VideoEncoder] File worker error:",e),this.fileWorker.terminate(),t(e)}});const e=await navigator.storage.getDirectory(),t=await e.getFileHandle(this.tempFileName,{create:!1}),i=await t.getFile(),s=URL.createObjectURL(i),r=document.createElement("a");r.href=s,r.download="processed-video.mp4",r.click(),URL.revokeObjectURL(s)}else{const e=this.chunks.sort((e,t)=>e.position-t.position),t=e[e.length-1],i=t.position+t.data.length,s=new Uint8Array(i);for(const t of e)s.set(t.data,t.position);const r=new Blob([s],{type:"video/mp4"}),a=URL.createObjectURL(r),n=document.createElement("a");n.href=a,n.download="processed-video.mp4",n.click(),URL.revokeObjectURL(a)}}}class y{constructor(){this.activeFrames=new Set,this.framePool=[],this.maxPoolSize=10,this.cleanupCallbacks=[],this.isShuttingDown=!1,this.cleanupPaused=!1}registerFrame(e,t="unknown"){if(!e||this.isShuttingDown)return;const i={frame:e,context:t,timestamp:Date.now(),closed:!1};this.activeFrames.add(i),this.cleanupCallbacks.push(()=>{this.closeFrame(i)})}closeFrame(e){if(e&&!e.closed)try{e.frame&&"function"==typeof e.frame.close&&e.frame.close(),e.closed=!0,this.activeFrames.delete(e)}catch(e){console.error("Error closing frame:",e)}}closeAllFrames(){const e=Array.from(this.activeFrames);e.forEach(e=>{this.closeFrame(e)}),console.log(`Closed ${e.length} active frames`)}getFrameFromPool(e){if(this.framePool.length>0){const e=this.framePool.pop();return this.registerFrame(e,"pool"),e}const t=e();return this.registerFrame(t,"new"),t}returnFrameToPool(e){!e||this.framePool.length>=this.maxPoolSize?this.closeFrame({frame:e,context:"pool-return",closed:!1}):e.codedWidth&&e.codedHeight?this.framePool.push(e):this.closeFrame({frame:e,context:"pool-return",closed:!1})}cleanupOldFrames(e=3e4){const t=Date.now(),i=[];this.activeFrames.forEach(s=>{t-s.timestamp>e&&i.push(s)}),i.forEach(e=>{this.closeFrame(e)}),i.length>0&&console.log(`Cleaned up ${i.length} old frames`)}getStats(){return{activeFrames:this.activeFrames.size,poolSize:this.framePool.length,maxPoolSize:this.maxPoolSize,isShuttingDown:this.isShuttingDown}}startPeriodicCleanup(e=1e4){this.cleanupInterval=setInterval(()=>{this.cleanupPaused||this.cleanupOldFrames()},e)}pauseCleanup(){this.cleanupPaused=!0}resumeCleanup(){this.cleanupPaused=!1}stopPeriodicCleanup(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null)}shutdown(){this.isShuttingDown=!0,this.stopPeriodicCleanup(),this.closeAllFrames(),this.framePool.forEach(e=>{try{e&&"function"==typeof e.close&&e.close()}catch(e){console.error("Error closing pooled frame:",e)}}),this.framePool=[],this.cleanupCallbacks.forEach(e=>{try{e()}catch(e){console.error("Error in cleanup callback:",e)}}),this.cleanupCallbacks=[],console.log("Resource manager shutdown complete")}async withFrame(e,t="operation"){let i=null;try{return i=await e(),i&&this.registerFrame(i,t),i}catch(e){throw i&&this.closeFrame({frame:i,context:t,closed:!1}),e}}async processFrame(e,t,i="processing"){if(!e)throw new Error("No frame provided for processing");this.registerFrame(e,i);try{return await t(e)}finally{this.closeFrame({frame:e,context:i,closed:!1})}}}class S{constructor({onFrameProcessed:e,onFinalized:t,sampleManager:i,uiManager:s,isChromeBased:r,fps:a}){this.onFrameProcessed=e,this.onFinalized=t,this.sampleManager=i,this.uiManager=s,this.isChromeBased=r,this.fps=a,this.decoder=null,this.encoder=null,this.state="idle",this.processingResolve=null,this.processingPromise=null,this.outputTaskPromises=[],this.previousPromise=Promise.resolve(),this.timeRangeStart=0,this.timeRangeEnd=0,this.resourceManager=new y,n("ProcessingPipeline","Processing pipeline initialized")}async setup(e){await this.setupDecoder(e),await this.setupEncoder(),this.state="ready"}async setupDecoder(e){try{this.decoder=new d({onFrame:e=>this.handleDecoderOutput(e),onError:e=>{a("ProcessingPipeline","Decoder error",e)},onDequeue:e=>this.dispatch(e),isChromeBased:this.isChromeBased}),await this.decoder.setup(e),this.uiManager.setStatus("decode","Decoder configured"),n("ProcessingPipeline","Decoder setup complete")}catch(e){throw a("ProcessingPipeline","Failed to setup decoder",e),e}}async setupEncoder(){this.encoder=new P;const{width:e,height:t}=this.getEncoderDimensions();await this.encoder.init(e,t,this.fps,!this.isChromeBased,!0)}getEncoderDimensions(){const{rotation:e,videoWidth:t,videoHeight:i,zoom:s}=this.uiManager,r=e%180!=0;return{width:64*Math.ceil((r?i:t)*s/64),height:64*Math.ceil((r?t:i)*s/64)}}async start(e,t){if("ready"!==this.state)throw new Error("Pipeline is not ready to start processing.");return this.timeRangeStart=e,this.timeRangeEnd=t,this.state="processing",this.timerDispatch(),this.dispatch(23),this.processingPromise=new Promise(e=>{this.processingResolve=e}),this.processingPromise}dispatch(e){"processing"===this.state&&(h(`Dispatching ${e} chunks`),this.sampleManager.requestChunks(e,e=>{this.decoder.decode(e)},async()=>{this.state="exhausted",await this.decoder.flush();let e=0;for(;this.decoder.decodeQueueSize>0&&e<200;)await new Promise(e=>setTimeout(e,50)),e++;let t=0;for(;this.encoder.encodeQueueSize>0&&t<200;)await new Promise(e=>setTimeout(e,50)),t++;await this.finalize()}))}timerDispatch(){"processing"===this.state&&(this.isChromeBased||this.decoder.startTimerDispatch(e=>{e>0&&this.dispatch(e),this.timerDispatch()}))}async handleDecoderOutput(e){if("processing"===this.state||"exhausted"===this.state){const t=this.previousPromise.then(()=>this.processFrame(e));return this.previousPromise=t,void this.outputTaskPromises.push(t)}this.resourceManager.closeFrame({frame:e,context:"pipeline",closed:!1})}async processFrame(e){const t=Math.floor(e.timestamp/1e3);if(t<this.timeRangeStart||t>this.timeRangeEnd)this.resourceManager.closeFrame({frame:e,context:"pipeline-out-of-range",closed:!1});else try{this.uiManager.drawFrame(e),this.uiManager.drawTimestamp(t);const i={timestamp:e.timestamp,duration:e.duration};e.close(),h(`videoFrameOptions: ${JSON.stringify(i)}`);const s=new VideoFrame(this.uiManager.canvas,i);return this.onFrameProcessed(),this.encoder.encode(s)}catch(e){throw console.error("Error processing frame:",e),e}}async finalize(){"finalized"!==this.state&&(this.state="finalized",await this.encoder.finalize(),this.onFinalized(),this.processingResolve&&this.processingResolve())}}class M{constructor(){this.currentState="idle",this.processingPromise=null,this.processingResolve=null,this.previousPromise=null,this.transitions={idle:["initializing","error"],initializing:["initialized","error"],initialized:["processing","finalized","error"],processing:["finalized","error"],finalized:["initialized","idle"],error:["idle","initializing"]}}transitionTo(e){return this.transitions[this.currentState].includes(e)?(console.log(`State transition: ${this.currentState} -> ${e}`),this.currentState=e,!0):(console.error(`Invalid state transition from ${this.currentState} to ${e}`),!1)}getCurrentState(){return this.currentState}isInState(e){return this.currentState===e}isProcessing(){return"processing"===this.currentState}isInitialized(){return"initialized"===this.currentState}setProcessingPromise(e,t){this.processingPromise=e,this.processingResolve=t}getProcessingPromise(){return this.processingPromise}resolveProcessing(){this.processingResolve&&(this.processingResolve(),this.processingResolve=null,this.processingPromise=null)}setPreviousPromise(e){this.previousPromise=e}getPreviousPromise(){return this.previousPromise}clearPreviousPromise(){this.previousPromise=null}hasPreviousPromise(){return null!==this.previousPromise}reset(){this.currentState="idle",this.processingPromise=null,this.processingResolve=null,this.previousPromise=null}}class E{constructor(e){this.uiManager=e,this.errorCount=0,this.maxRetries=3}async handleError(e,t,i={}){const{showToUser:s=!0,retry:r=!1,retryFunction:a=null,critical:n=!1}=i;if(this.logError(e,t),s&&this.showUserError(e,t,n),r&&a&&this.errorCount<this.maxRetries){this.errorCount++,console.log(`Retrying operation (attempt ${this.errorCount}/${this.maxRetries})`);try{return await new Promise(e=>setTimeout(e,1e3*this.errorCount)),await a()}catch(e){return this.handleError(e,t,i)}}if((!r||this.errorCount>=this.maxRetries)&&(this.errorCount=0),n)throw e;return null}logError(e,t){const i={message:e.message,stack:e.stack,context:t,timestamp:(new Date).toISOString(),userAgent:navigator.userAgent};console.error("Video Processing Error:",i),"undefined"!=typeof window&&window.gtag&&window.gtag("event","exception",{description:`${t}: ${e.message}`,fatal:!1})}showUserError(e,t,i=!1){const s=this.getUserFriendlyMessage(e,t);this.uiManager?this.uiManager.setStatus("error",s):alert(`Error: ${s}`),i&&console.error("Critical error occurred:",e)}getUserFriendlyMessage(e,t){const i=e.message.toLowerCase();return i.includes("not supported")||i.includes("unsupported")?"This video format is not supported. Please try a different video file.":i.includes("network")||i.includes("fetch")?"Network error occurred. Please check your internet connection and try again.":i.includes("memory")||i.includes("out of memory")?"The video file is too large to process. Please try a smaller video file.":i.includes("permission")||i.includes("access")?"Permission denied. Please check your browser settings and try again.":i.includes("timeout")?"Operation timed out. Please try again with a shorter video segment.":i.includes("codec")||i.includes("encoding")?"Video encoding error. Please try a different video format.":{"file loading":"Failed to load video file. Please check the file and try again.",decoding:"Failed to decode video. The file may be corrupted or unsupported.",encoding:"Failed to encode video. Please try different settings.",processing:"Video processing failed. Please try again.",preview:"Failed to generate preview. Please try again.",initialization:"Failed to initialize video processor. Please refresh the page and try again."}[t]||"An unexpected error occurred. Please try again."}validateVideoFile(e){return e?e.type.startsWith("video/")?e.size>1572864e3?{isValid:!1,error:"Video file is too large (max 1.5GB)"}:["video/mp4","video/webm","video/ogg","video/quicktime","video/x-msvideo"].includes(e.type)?{isValid:!0,error:null}:{isValid:!1,error:"Video format not supported"}:{isValid:!1,error:"Selected file is not a video"}:{isValid:!1,error:"No file selected"}}checkBrowserSupport(){const e=[];window.VideoDecoder||e.push("VideoDecoder API"),window.VideoEncoder||e.push("VideoEncoder API"),window.VideoFrame||e.push("VideoFrame API"),window.EncodedVideoChunk||e.push("EncodedVideoChunk API");const t=0===e.length;return t||console.error("Missing browser features:",e),{supported:t,missingFeatures:e}}}class F{constructor({canvas:e,statusElement:t,frameCountDisplay:i,timestampProvider:s}){this.uiManager=new v({canvas:e,statusElement:t,frameCountDisplay:i,timestampProvider:s}),this.stateManager=new M,this.errorHandler=new E(this.uiManager),this.resourceManager=new y,this.sampleManager=new l,this.timestampProvider=s,this.isChromeBased=navigator.userAgent.toLowerCase().includes("chrome"),this.startProcessVideoTime=void 0,this.mp4StartTime=void 0,this.decoder=null,this.previewManager=null,this.lastPreviewPercentage=0,this.zoom=1,this.rotation=0,this.fps=0,this.videoWidth=0,this.videoHeight=0,this.matrix=void 0,this.videoConfig=null,this.nb_samples=0,this.frame_count=0,this.timeRangeStart=void 0,this.timeRangeEnd=void 0,this.pipeline=null,this.resourceManager.startPeriodicCleanup(),n("VideoProcessor","VideoProcessor initialized")}setInitialRotation(e){if(!e)return;const t=1/65536,[i,s,,r,a]=e.map(e=>e*t);let n=0;0===i&&1===s&&-1===r&&0===a?n=90:0===i&&-1===s&&1===r&&0===a?n=-90:-1===i&&-1===a&&(n=180),this.updateRotation(n)}get state(){return this.stateManager.getCurrentState()}async updateRotation(e){this.rotation=e,this.uiManager.updateRotation(e),"initialized"===this.state&&await this.renderSampleInPercentage(this.lastPreviewPercentage)}async updateZoom(e){this.zoom=e,this.uiManager.updateZoom(e),"initialized"===this.state&&await this.renderSampleInPercentage(this.lastPreviewPercentage)}async finalize(){if(!this.stateManager.isInState("finalized")){const e=performance.now()-this.startProcessVideoTime,t=this.frame_count/(e/1e3);!function(e,t,i=null){if(null!==i&&r.recordPerformance(e,i),s.enablePerformanceLogging){const i=r.getPerformanceStats(e);i&&(t+=` (avg: ${i.average.toFixed(2)}ms, min: ${i.min}ms, max: ${i.max}ms)`),r.log(2,"PERFORMANCE",t)}}("VideoProcessing",`Total processing time: ${e}ms, FPS: ${t.toFixed(2)}`,e),this.stateManager.transitionTo("finalized"),this.stateManager.resolveProcessing(),n("VideoProcessor","Video processing finalized",{totalTime:e,fps:t.toFixed(2),frameCount:this.frame_count})}}async initFile(e){const t=this.errorHandler.validateVideoFile(e);if(!t.isValid)throw new Error(t.error);const i=this.errorHandler.checkBrowserSupport();if(!i.supported)throw new Error(`Browser not supported. Missing features: ${i.missingFeatures.join(", ")}`);if(!this.stateManager.isInState("idle"))throw new Error("Processor is not idle");this.stateManager.transitionTo("initializing"),n("VideoProcessor","Starting file initialization",{fileName:e.name,fileSize:e.size});try{const t=URL.createObjectURL(e);await this.setupDemuxer(t),URL.revokeObjectURL(t)}catch(e){throw this.stateManager.transitionTo("error"),await this.errorHandler.handleError(e,"file loading",{showToUser:!0,critical:!1}),e}}resetForReprocessing(){this.stateManager.isInState("finalized")&&(this.stateManager.transitionTo("initialized"),this.sampleManager.resetForReprocessing(),o("VideoProcessor","Reset for reprocessing"))}async processFile(){if(this.resetForReprocessing(),!this.stateManager.isInState("initialized"))throw new Error("Processor is not initialized");await this.waitForPreviousPromise(),this.frame_count=0,this.uiManager.updateFrameCount(this.frame_count,this.nb_samples),this.uiManager.createTimestampRenderer(this.timestampProvider.getUserStartTime(),this.mp4StartTime,this.timeRangeStart),this.pipeline=new S({onFrameProcessed:()=>{this.frame_count++,this.uiManager.updateFrameCount(this.frame_count,this.nb_samples)},onFinalized:()=>this.finalize(),sampleManager:this.sampleManager,uiManager:this.uiManager,isChromeBased:this.isChromeBased,fps:this.fps});try{await this.pipeline.setup(this.videoConfig)}catch(e){throw await this.errorHandler.handleError(e,"pipeline setup",{showToUser:!0,critical:!0}),e}let e;this.stateManager.transitionTo("processing"),this.resourceManager.pauseCleanup();const t=new Promise(t=>{e=t});this.stateManager.setProcessingPromise(t,e);try{await this.pipeline.start(this.timeRangeStart,this.timeRangeEnd)}catch(e){throw this.stateManager.transitionTo("error"),await this.errorHandler.handleError(e,"processing",{showToUser:!0,critical:!1}),e}finally{this.resourceManager.resumeCleanup()}}async processFileByTime(e,t){this.startProcessVideoTime=performance.now(),[this.nb_samples,this.timeRangeStart,this.timeRangeEnd]=this.sampleManager.finalizeTimeRange(e,t),this.uiManager.updateFrameCount(0,this.nb_samples),await this.processFile()}async processFileByFrame(e,t){this.startProcessVideoTime=performance.now(),[this.nb_samples,this.timeRangeStart,this.timeRangeEnd]=this.sampleManager.finalizeSampleInIndex(e,t),this.uiManager.updateFrameCount(0,this.nb_samples),await this.processFile()}async setupDemuxer(e){new m(e,{onConfig:e=>this.setup(e),setStatus:(e,t)=>this.uiManager.setStatus(e,t),sampleManager:this.sampleManager})}async setup(e){try{this.videoConfig=e,this.videoWidth=e.codedWidth,this.videoHeight=e.codedHeight,this.matrix=e.matrix,this.fps=e.fps,this.mp4StartTime=e.startTime,n("VideoProcessor","Video configuration received",{width:this.videoWidth,height:this.videoHeight,fps:this.fps,codec:e.codec}),await this.setupPreviewDecoder(e),this.uiManager.setup(this.videoWidth,this.videoHeight,this.matrix,this.zoom,this.rotation),this.setInitialRotation(this.matrix),this.frame_count=0,this.uiManager.updateFrameCount(0,0),this.stateManager.transitionTo("initialized"),this.previewManager=new p(this.decoder,this.sampleManager),this.onInitialized&&this.onInitialized(this.sampleManager.sampleCount()),n("VideoProcessor","Video processor setup complete")}catch(e){throw this.stateManager.transitionTo("error"),await this.errorHandler.handleError(e,"initialization",{showToUser:!0,critical:!0}),e}}async setupPreviewDecoder(e){try{this.decoder=new d({onFrame:e=>this.handlePreviewDecoderOutput(e),onError:e=>{a("PreviewDecoder","Decoder error",e)},isChromeBased:this.isChromeBased}),await this.decoder.setup(e),this.uiManager.setStatus("decode","Preview Decoder configured"),await this.sampleManager.waitForReady(),n("VideoProcessor","Preview decoder setup complete")}catch(e){throw await this.errorHandler.handleError(e,"preview decoder setup",{showToUser:!0,critical:!1}),e}}async handlePreviewDecoderOutput(e){if(!this.stateManager.isInState("initialized"))throw this.resourceManager.closeFrame({frame:e,context:"preview",closed:!1}),new Error("Processor should be in the initialized state for previewing");try{await this.resourceManager.processFrame(e,e=>{this.previewManager.drawPreview(e,e=>this.uiManager.drawFrame(e))},"preview")}catch(e){throw a("VideoProcessor","Error handling preview frame",e),e}}async renderSampleInPercentage(e){if(this.resetForReprocessing(),!this.stateManager.isInState("initialized"))throw new Error("Processor should be in the initialized state");this.lastPreviewPercentage=e,o("VideoProcessor",`Rendering preview at ${e}%`);try{const t=this.previewManager.preparePreview(e);await this.waitForPreviousPromise();const i=this.previewManager.executePreview(t);i&&this.stateManager.setPreviousPromise(i)}catch(e){throw await this.errorHandler.handleError(e,"preview",{showToUser:!1,critical:!1}),e}}isProcessing(){return this.stateManager.isProcessing()}async waitForProcessing(){if(!this.stateManager.isProcessing())return;const e=this.stateManager.getProcessingPromise();e&&await e}get hasPreviousPromise(){return this.stateManager.hasPreviousPromise()}async waitForPreviousPromise(){let e=this.stateManager.getPreviousPromise();for(;e&&(await e,e!==this.stateManager.getPreviousPromise());)e=this.stateManager.getPreviousPromise();return this.stateManager.clearPreviousPromise(),!0}shutdown(){n("VideoProcessor","Shutting down video processor"),this.resourceManager.shutdown(),this.stateManager.reset()}}"serviceWorker"in navigator?window.addEventListener("load",()=>{navigator.serviceWorker.register("./service-worker.js").then(e=>{console.log("[App] Service Worker registered:",e.scope),setInterval(()=>{e.update()},6e4),e.addEventListener("updatefound",()=>{const t=e.installing;console.log("[App] Service Worker update found"),t.addEventListener("statechange",()=>{"installed"===t.state&&navigator.serviceWorker.controller&&(console.log("[App] New version available"),function(){const e=document.getElementById("status");if(e&&!e.textContent.includes("New version")){const t=e.textContent;e.textContent="ðŸ”„ New version available - Refresh to update",e.style.backgroundColor="#4CAF50",e.style.color="white",e.style.cursor="pointer",e.onclick=()=>{window.location.reload()},setTimeout(()=>{e.textContent.includes("New version")&&(e.textContent=t,e.style.backgroundColor="",e.style.color="",e.style.cursor="",e.onclick=null)},1e4)}}())})})}).catch(e=>{console.warn("[App] Service Worker registration failed:",e)})}):console.info("[App] Service Worker not supported, using standard caching"),(()=>{try{["videoInput","startTime","endTime","enableTimestamp","timestampStart","zoomSlider","rotateCW","rotateCCW"].forEach(e=>{const t=document.getElementById(e);t&&(t.disabled=!1)}),document.querySelectorAll('input[name="timeSelection"]').forEach(e=>{e.disabled=!1})}catch(e){console.error("[App] Error enabling controls:",e)}finally{const e=document.getElementById("loadingOverlay");e&&e.classList.add("hidden")}})();const C=new class{constructor(){this.timeSelectionRadios=document.getElementsByName("timeSelection"),this.sliderContainer=document.querySelector(".slider-container"),this.timeInputs=document.querySelector(".time-inputs"),this.thumbStart=document.getElementById("thumbStart"),this.thumbEnd=document.getElementById("thumbEnd"),this.sliderTrack=document.querySelector(".slider-track"),this.sliderRange=document.querySelector(".slider-range"),this.startFrameDisplay=document.getElementById("startFrame"),this.endFrameDisplay=document.getElementById("endFrame"),this.totalFramesDisplay=document.getElementById("totalFrames"),this.isDragging=null,this.startPercent=0,this.endPercent=100,this.totalFrames=0,this.initializeEventListeners()}initializeEventListeners(){this.timeSelectionRadios.forEach(e=>{e.addEventListener("change",e=>{const t="slider"===e.target.value;this.sliderContainer.classList.toggle("visible",t),this.timeInputs.classList.toggle("visible",!t)})}),[this.thumbStart,this.thumbEnd].forEach(e=>{e.addEventListener("mousedown",this.handleStart.bind(this)),e.addEventListener("touchstart",this.handleStart.bind(this))})}handleStart(e){e.preventDefault();const t=e.target;this.isDragging=t.id;const i=e=>this.handleMove(e),s=e=>{document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",s),document.removeEventListener("touchmove",i),document.removeEventListener("touchend",s),this.isDragging=null};document.addEventListener("mousemove",i),document.addEventListener("mouseup",s),document.addEventListener("touchmove",i),document.addEventListener("touchend",s)}handleMove(e){if(!this.isDragging)return;const t=this.sliderTrack.getBoundingClientRect();let i=((e.type.includes("touch")?e.touches[0].clientX:e.clientX)-t.left)/t.width*100;i=Math.max(0,Math.min(100,i)),"thumbStart"===this.isDragging?(this.startPercent=Math.min(i,this.endPercent-1),this.onUpdatePercentage(this.startPercent)):(this.endPercent=Math.max(i,this.startPercent+1),this.onUpdatePercentage(this.endPercent)),this.updateSliderDisplay()}initialize(e){this.totalFramesDisplay.textContent=e,this.totalFrames=e,this.updateSliderDisplay()}updateSliderDisplay(){this.thumbStart.style.left=`${this.startPercent}%`,this.thumbEnd.style.left=`${this.endPercent}%`,this.sliderRange.style.left=`${this.startPercent}%`,this.sliderRange.style.width=this.endPercent-this.startPercent+"%";const e=parseInt(this.totalFramesDisplay.textContent)||0,t=Math.floor(this.startPercent/100*e),i=Math.floor(this.endPercent/100*e);this.startFrameDisplay.textContent=t,this.endFrameDisplay.textContent=i}isSliderModeActive(){return this.sliderContainer.classList.contains("visible")}getFrameRange(){const e=this.totalFrames;return{startFrame:Math.floor(this.startPercent/100*e),endFrame:Math.floor(this.endPercent/100*e)}}onUpdatePercentage(e){this.onupdatepercentage&&this.onupdatepercentage(e)}},T=new class{constructor({startTimeInput:e,endTimeInput:t}){this.startTimeInput=e,this.endTimeInput=t}convertTimeToMs(e){const[t,i]=e.split(":").map(Number);return 1e3*(60*t+i)}validateTimeInput(e){/^[0-5][0-9]:[0-5][0-9]$/.test(e.value)||(e.value="00:00")}getTimeRange(){this.validateTimeInput(this.startTimeInput),this.validateTimeInput(this.endTimeInput);const e=this.convertTimeToMs(this.startTimeInput.value),t=this.convertTimeToMs(this.endTimeInput.value);let i=e>0?e:void 0,s=t>0?t:void 0;return void 0!==s&&void 0!==i&&s<=i&&(s=void 0,this.endTimeInput.value="00:00"),{startMs:i,endMs:s}}}({startTimeInput:document.getElementById("startTime"),endTimeInput:document.getElementById("endTime")}),I=new class{constructor({timestampStartInput:e,enableTimestampCheckbox:t,timestampInputs:i}){this.timestampStartInput=e,this.enableTimestampCheckbox=t,this.timestampInputs=i,this.userStartTime=null,this.enableTimestampCheckbox.addEventListener("change",()=>{this.timestampInputs.classList.toggle("visible",this.enableTimestampCheckbox.checked)})}isEnabled(){return this.enableTimestampCheckbox.checked}validateTimestampInput(){return!(this.timestampStartInput.value&&!/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(this.timestampStartInput.value)&&(alert("Invalid timestamp format. Please use YYYY-MM-DD HH:MM:SS"),this.timestampStartInput.value="",1))}getUserStartTime(){if(!this.timestampStartInput.value)return null;if(!this.validateTimestampInput())return null;const e=new Date(this.timestampStartInput.value);return isNaN(e.getTime())?(alert("Invalid date. Please check your input."),null):e}}({timestampStartInput:document.getElementById("timestampStart"),enableTimestampCheckbox:document.getElementById("enableTimestamp"),timestampInputs:document.getElementById("timestampInputs")});let x=null,b=null;document.getElementById("videoInput").addEventListener("change",async e=>{const t=e.target.files[0];if(t)try{b||(b=new E({setStatus:(e,t)=>{document.getElementById("status").textContent=`${e}: ${t}`}})),null!=x&&(x.isProcessing()&&await x.waitForProcessing(),x.shutdown()),n("Main","Initializing video processor",{fileName:t.name}),x=new F({canvas:document.getElementById("processorCanvas"),statusElement:document.getElementById("status"),frameCountDisplay:document.getElementById("frameCount"),timestampProvider:I,frameRangeSlider:C}),x.onInitialized=e=>{C.initialize(e),document.getElementById("processButton").disabled=!1,C.onupdatepercentage=e=>{x.renderSampleInPercentage(e)},x.renderSampleInPercentage(0),n("Main","Video processor initialized",{sampleCount:e})},await x.initFile(t)}catch(e){a("Main","Failed to initialize video processor",e),document.getElementById("processButton").disabled=!0,document.getElementById("status").textContent=`Error: ${e.message}`}else document.getElementById("processButton").disabled=!0}),document.getElementById("processButton").addEventListener("click",async()=>{if(document.getElementById("videoInput").files[0])try{if(document.getElementById("processButton").disabled=!0,n("Main","Starting video processing"),C.isSliderModeActive()){const{startFrame:e,endFrame:t}=C.getFrameRange();n("Main","Processing by frame range",{startFrame:e,endFrame:t}),await x.processFileByFrame(e,t)}else{const{startMs:e,endMs:t}=T.getTimeRange();n("Main","Processing by time range",{startMs:e,endMs:t}),await x.processFileByTime(e,t)}n("Main","Video processing completed successfully")}catch(e){a("Main","Error processing video",e),b?await b.handleError(e,"processing",{showToUser:!0,critical:!1}):document.getElementById("status").textContent="Error processing video"}finally{document.getElementById("processButton").disabled=!1}}),document.getElementById("zoomSlider").addEventListener("input",async e=>{const t=e.target.value/100;document.getElementById("zoomValue").textContent=`${e.target.value}%`,x&&"initialized"===x.state&&await x.updateZoom(t)}),document.getElementById("rotateCW").addEventListener("click",async()=>{x&&await x.updateRotation((x.rotation+90)%360)}),document.getElementById("rotateCCW").addEventListener("click",async()=>{x&&await x.updateRotation((x.rotation-90+360)%360)})}},e=>{e.O(0,[96],()=>e(e.s=465)),e.O()}]);