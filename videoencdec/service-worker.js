const CACHE_VERSION="v1",CACHE_NAME="video-processor-v1",PRECACHE_ASSETS=["./"];self.addEventListener("install",e=>{console.log("[Service Worker] Installing..."),e.waitUntil(caches.open(CACHE_NAME).then(e=>(console.log("[Service Worker] Precaching assets"),e.addAll(PRECACHE_ASSETS).catch(e=>{console.warn("[Service Worker] Precaching failed (non-critical):",e)}))).then(()=>self.skipWaiting()))}),self.addEventListener("activate",e=>{console.log("[Service Worker] Activating..."),e.waitUntil(caches.keys().then(e=>Promise.all(e.map(e=>{if(e!==CACHE_NAME)return console.log("[Service Worker] Deleting old cache:",e),caches.delete(e)}))).then(()=>self.clients.claim()))}),self.addEventListener("fetch",e=>{const{request:c}=e;new URL(c.url).origin===location.origin&&e.respondWith((async()=>{if(c.url.match(/\.[a-f0-9]{8,}\.(js|css)$/)){const e=await caches.match(c);if(e)return console.log("[Service Worker] Cache hit (immutable):",c.url),e;try{const e=await fetch(c);if(e&&e.ok){const t=await caches.open(CACHE_NAME),r=e.clone();t.put(c,r),console.log("[Service Worker] Cached new asset:",c.url)}return e}catch(e){throw console.error("[Service Worker] Fetch failed:",c.url,e),e}}if("navigate"===c.mode||c.url.endsWith(".html"))try{const e=await fetch(c);if(e&&e.ok){const t=await caches.open(CACHE_NAME),r=e.clone();t.put(c,r),console.log("[Service Worker] Updated HTML cache:",c.url)}return e}catch(e){const t=await caches.match(c);if(t)return console.log("[Service Worker] Network failed, serving cached HTML"),t;throw e}const e=await caches.match(c),t=fetch(c).then(async e=>{if(e&&e.ok)try{const t=await caches.open(CACHE_NAME),r=e.clone();await t.put(c,r),console.log("[Service Worker] Background updated:",c.url)}catch(e){console.warn("[Service Worker] Cache update failed:",c.url,e)}return e}).catch(t=>(console.warn("[Service Worker] Fetch failed:",c.url,t),e));return e||t})())}),self.addEventListener("message",e=>{e.data&&"SKIP_WAITING"===e.data.type&&(console.log("[Service Worker] Received SKIP_WAITING message"),self.skipWaiting()),e.data&&"CHECK_UPDATE"===e.data.type&&(console.log("[Service Worker] Checking for updates..."),self.registration.update())});